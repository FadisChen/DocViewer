<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文檔檢視器 - DocViewer</title>

    <!-- 引入 CodeMirror 6 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@6/dist/index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6/dist/index.css">

    <!-- 引入 Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css"
        media="(prefers-color-scheme: dark)">

    <!-- 自定義樣式 -->
    <style>
        :root {
            --primary-color: #007acc;
            --secondary-color: #f5f5f5;
            --background-color: #ffffff;
            --text-color: #333333;
            --border-color: #e1e4e8;
            --editor-bg: #ffffff;
            --preview-bg: #ffffff;
            --quote-color: #b00;
        }

        [data-theme="dark"] {
            --secondary-color: #2d3748;
            --background-color: #1a202c;
            --text-color: #e2e8f0;
            --border-color: #4a5568;
            --editor-bg: #2d3748;
            --preview-bg: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            height: 60px;
            background-color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            transition: background-color 0.3s ease;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--background-color);
            color: var(--text-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .container {
            height: calc(100vh - 60px);
            display: flex;
        }

        .editor-panel {
            flex: 1;
            background-color: var(--editor-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .preview-panel {
            flex: 1;
            background-color: var(--preview-bg);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            height: 40px;
            background-color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-weight: 500;
            font-size: 14px;
        }

        .editor-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .editor-textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            padding: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            background-color: var(--editor-bg);
            color: var(--text-color);
            resize: none;
            line-height: 1.5;
        }

        .preview-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .resizer {
            width: 5px;
            min-width: 5px;
            max-width: 5px;
            background-color: var(--border-color);
            cursor: col-resize;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
            flex-grow: 0;
            user-select: none;
            position: relative;
            z-index: 10;
        }

        .resizer:hover {
            background-color: var(--primary-color);
        }

        .resizer.dragging {
            background-color: var(--primary-color);
            opacity: 0.8;
        }

        /* Markdown 渲染樣式 */
        .preview-content h1,
        .preview-content h2,
        .preview-content h3,
        .preview-content h4,
        .preview-content h5,
        .preview-content h6 {
            margin: 1em 0 0.5em 0;
            color: var(--text-color);
        }

        .preview-content h1 {
            font-size: 2em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }

        .preview-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }

        .preview-content p {
            margin: 1em 0;
            line-height: 1.6;
        }

        .preview-content pre {
            background-color: var(--secondary-color);
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }

        .preview-content code {
            background-color: var(--secondary-color);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .preview-content blockquote {
            border-left: 4px solid var(--quote-color);
            padding-left: 16px;
            margin: 1em 0;
        }

        .preview-content ul,
        .preview-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }

        .preview-content li {
            margin: 0.5em 0;
        }

        .preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .preview-content th,
        .preview-content td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }

        .preview-content th {
            background-color: var(--secondary-color);
            font-weight: 600;
        }

        /* Mermaid 圖表樣式 */
        .mermaid {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .mermaid:hover {
            transform: scale(1.02);
        }

        /* 模態視窗樣式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: var(--background-color);
            margin: 2% auto;
            padding: 20px;
            width: 90%;
            height: 90%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        .modal-diagram {
            cursor: grab;
        }

        .modal-diagram.grabbing {
            cursor: grabbing;
        }

        .modal-diagram .mermaid {
            cursor: grab;
        }

        .modal-diagram.grabbing .mermaid {
            cursor: grabbing;
        }

        .modal-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 1010;
        }

        .modal-btn {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            transition: all 0.2s ease;
        }

        .modal-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .modal-diagram {
            width: 100%;
            height: calc(100% - 40px);
            display: flex;
            align-items: center;
            justify-content: center;
            transform-origin: center center;
        }

        /* 錯誤提示樣式 */
        .error-message {
            background-color: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        .error-message strong {
            color: #a00;
            font-weight: bold;
        }

        .error-message details {
            margin-top: 10px;
        }

        .error-message summary {
            cursor: pointer;
            color: #666;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .error-message pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 5px;
            color: #333;
        }

        /* 編輯器隱藏狀態 */
        .editor-hidden .editor-panel {
            display: none;
        }

        .editor-hidden .resizer {
            display: none;
        }

        .editor-hidden .preview-panel {
            flex: 1;
        }

        /* 響應式設計 */
        @media (max-width: 1024px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .header-controls {
                gap: 8px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 15px;
                height: 50px;
            }

            .header h1 {
                font-size: 1.1rem;
            }

            .header-controls {
                gap: 6px;
            }

            .btn {
                padding: 5px 10px;
                font-size: 12px;
            }

            .container {
                height: calc(100vh - 50px);
                flex-direction: column;
            }

            .editor-panel {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                min-height: 0;
                max-height: 60vh;
            }

            .preview-panel {
                flex: 1;
                min-height: 0;
            }

            .resizer {
                width: 100%;
                height: 5px;
                cursor: row-resize;
                min-height: 5px;
                max-height: 5px;
            }

            .panel-header {
                height: 35px;
                padding: 0 12px;
                font-size: 13px;
            }

            .editor-textarea {
                padding: 12px;
                font-size: 13px;
            }

            .preview-container {
                padding: 15px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0 10px;
                height: 45px;
            }

            .header h1 {
                font-size: 1rem;
            }

            .header-controls {
                gap: 4px;
            }

            .btn {
                padding: 4px 8px;
                font-size: 11px;
            }

            .container {
                height: calc(100vh - 45px);
            }

            .editor-panel {
                min-height: 35vh;
                max-height: 65vh;
            }

            .panel-header {
                height: 30px;
                padding: 0 10px;
                font-size: 12px;
            }

            .editor-textarea {
                padding: 10px;
                font-size: 12px;
            }

            .preview-container {
                padding: 10px;
            }

            .preview-content h1 {
                font-size: 1.5em;
            }

            .preview-content h2 {
                font-size: 1.3em;
            }

            .preview-content {
                font-size: 14px;
            }
        }

        /* 載入動畫 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 自定義 Scroll Bar 樣式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        ::-webkit-scrollbar-corner {
            background: var(--secondary-color);
        }

        /* Firefox scroll bar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--secondary-color);
        }

        .hljs {
            color: inherit !important;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>📝 DocViewer</h1>
        <div class="header-controls">
            <button class="btn" id="toggleEditor">📝 隱藏</button>
            <button class="btn" id="themeToggle">🌙 深色</button>
            <button class="btn" id="clearBtn">🗑️ 清除</button>
            <button class="btn" id="importBtn">📥 匯入</button>
            <button class="btn btn-primary" id="exportBtn">📤 匯出</button>
        </div>
    </div>

    <input type="file" id="fileInput" hidden accept=".md,.txt">

    <div class="container">
        <div class="editor-panel">
            <div class="panel-header">
                📝 編輯區
            </div>
            <div class="editor-container">
                <textarea class="editor-textarea" id="editor" placeholder="在此輸入 Markdown 或 Mermaid 語法..."></textarea>
            </div>
        </div>

        <div class="resizer" id="resizer"></div>

        <div class="preview-panel">
            <div class="panel-header">
                👁️ 即時預覽
            </div>
            <div class="preview-container">
                <div class="preview-content" id="preview">
                    <h1>歡迎使用 DocViewer</h1>
                    <p>請在左側編輯器中輸入 Markdown 或 Mermaid 語法，這裡會即時顯示渲染結果。</p>

                    <h2>範例 - Mermaid 流程圖</h2>
                    <div class="mermaid">
                        graph TD
                        A[開始] --> B{是否為 Markdown?}
                        B -->|是| C[渲染 Markdown]
                        B -->|否| D{是否為 Mermaid?}
                        D -->|是| E[渲染 Mermaid 圖表]
                        D -->|否| F[顯示純文字]
                        C --> G[顯示結果]
                        E --> G
                        F --> G
                    </div>

                    <h2>範例 - Markdown 語法</h2>
                    <pre><code># 標題 1
## 標題 2
### 標題 3

**粗體文字**
*斜體文字*
`程式碼`

- 清單項目 1
- 清單項目 2
- 清單項目 3

| 欄位1 | 欄位2 | 欄位3 |
|-------|-------|-------|
| 值1   | 值2   | 值3   |</code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入所需的 JavaScript 庫 -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

    <!-- 引入 highlight.js -->
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/common/highlight.min.js"></script>

    <script>
        // 全域變量
        let md;
        let isDarkTheme = false;

        // 初始化 Markdown-it
        md = window.markdownit({
            html: true,
            linkify: true,
            typographer: false,
            highlight: function (str, lang) {
                if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                    try {
                        return '<pre><code class="hljs language-' + lang + '">' +
                            hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                            '</code></pre>';
                    } catch (__) { }
                }
                // 如果沒有指定語言、hljs 未定義或高亮失敗，直接返回原始碼，並用 pre 和 code 包裹
                return '<pre><code class="hljs">' + md.utils.escapeHtml(str) + '</code></pre>';
            }
        });

        // 初始化 Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });

        // 預設內容
        const defaultContent = `# 歡迎使用 DocViewer

這是一個功能強大的文檔檢視器，支援 **Markdown** 和 **Mermaid** 即時渲染。

## Mermaid 流程圖範例

\`\`\`mermaid
graph TD
A[用戶輸入] --> B{內容類型判斷}
B -->|Markdown| C[Markdown 渲染]
B -->|Mermaid| D[Mermaid 圖表渲染]
C --> E[顯示結果]
D --> E
E --> F[用戶查看]
\`\`\`

## Markdown 語法範例

### 文字格式
- **粗體文字**
- *斜體文字*
- ~~刪除線~~
- \`行內程式碼\`

### 清單
1. 有序清單項目 1
2. 有序清單項目 2
- 巢狀無序清單
- 另一個項目

### 表格
| 功能 | 支援狀態 | 說明 |
|------|---------|------|
| Markdown 渲染 | ✅ | 完整支援 |
| Mermaid 圖表 | ✅ | 即時渲染 |
| 語法高亮 | ✅ | 程式碼高亮 |
| 主題切換 | ✅ | 明暗主題 |

### 引用
> 這是一個引用文字，用來突出重要資訊。

### 程式碼區塊
\`\`\`javascript
function hello() {
console.log("Hello, DocViewer!");
}
\`\`\`

## 序列圖範例

\`\`\`mermaid
sequenceDiagram
participant U as 用戶
participant E as 編輯器
participant P as 預覽器

U->>E: 輸入內容
E->>P: 傳送內容
P->>P: 解析渲染
P->>U: 顯示結果
\`\`\`
`;

        // 獲取 DOM 元素
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const toggleEditor = document.getElementById('toggleEditor');
        const themeToggle = document.getElementById('themeToggle');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const fileInput = document.getElementById('fileInput');

        // 設置預設內容
        editor.value = defaultContent;

        // 更新預覽
        async function updatePreview() {
            const content = editor.value;

            try {
                // 先提取所有 Mermaid 程式碼區塊
                const mermaidBlocks = [];
                let processedContent = content.replace(/```mermaid\n([\s\S]*?)\n```/g, (match, code) => {
                    const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                    const cleanCode = code.trim();
                    mermaidBlocks.push({ id, code: cleanCode });
                    return `<div class="mermaid-placeholder" data-id="${id}"></div>`;
                });

                // 渲染 Markdown（不包含 Mermaid 圖表）
                const html = md.render(processedContent);
                preview.innerHTML = html;

                // 渲染 Mermaid 圖表
                const placeholders = preview.querySelectorAll('.mermaid-placeholder');
                for (let i = 0; i < placeholders.length && i < mermaidBlocks.length; i++) {
                    const placeholder = placeholders[i];
                    const block = mermaidBlocks[i];

                    try {
                        // 清理 Mermaid 代碼，移除可能的 HTML 標籤和多餘空白
                        const cleanCode = block.code
                            .replace(/<[^>]*>/g, '') // 移除 HTML 標籤
                            .replace(/&lt;/g, '<')   // 解碼 HTML 實體
                            .replace(/&gt;/g, '>')
                            .replace(/&amp;/g, '&')
                            .trim();

                        const { svg } = await mermaid.render(block.id, cleanCode);
                        placeholder.outerHTML = `<div class="mermaid" id="${block.id}">${svg}</div>`;
                    } catch (error) {
                        console.error('Mermaid 渲染錯誤:', error);
                        placeholder.outerHTML = `<div class="error-message">
                    <strong>圖表渲染錯誤:</strong><br/>
                    ${error.message}<br/>
                    <details>
                        <summary>查看原始代碼</summary>
                        <pre>${block.code}</pre>
                    </details>
                </div>`;
                    }
                }
            } catch (error) {
                console.error('預覽更新錯誤:', error);
                preview.innerHTML = `<div class="error-message">預覽錯誤: ${error.message}</div>`;
            }
        }

        // 主題切換
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            const body = document.body;

            if (isDarkTheme) {
                body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = '☀️ 淺色';

                // 更新 Mermaid 主題
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'dark',
                    securityLevel: 'loose'
                });
            } else {
                body.removeAttribute('data-theme');
                themeToggle.textContent = '🌙 深色';

                // 重置 Mermaid 主題
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    securityLevel: 'loose'
                });
            }

            // 重新渲染預覽
            updatePreview();
        }

        // 清除內容
        function clearContent() {
            if (confirm('確定要清除所有內容嗎？')) {
                editor.value = '';
                updatePreview();
            }
        }

        // 切換編輯器顯示/隱藏
        function toggleEditorVisibility() {
            const container = document.querySelector('.container');
            const editorPanel = document.querySelector('.editor-panel');
            const previewPanel = document.querySelector('.preview-panel');
            const isHidden = container.classList.contains('editor-hidden');

            if (isHidden) {
                // 顯示編輯器
                container.classList.remove('editor-hidden');
                toggleEditor.textContent = '📝 隱藏';

                // 如果之前有拖曳過，恢復之前的比例，否則使用預設 50:50
                if (!editorPanel.style.flex || editorPanel.style.flex === '') {
                    editorPanel.style.flex = '1';
                    previewPanel.style.flex = '1';
                }
            } else {
                // 隱藏編輯器
                container.classList.add('editor-hidden');
                toggleEditor.textContent = '📝 顯示';

                // 重置預覽區為佔滿整個寬度，覆蓋任何之前的 flex 設定
                previewPanel.style.flex = '1';
            }
        }

        // 匯出功能
        function exportContent() {
            const content = editor.value;
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.md';
            a.click();
            URL.revokeObjectURL(url);
        }

        // 面板大小調整
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const editorPanel = document.querySelector('.editor-panel');
            const previewPanel = document.querySelector('.preview-panel');
            const container = document.querySelector('.container');
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                resizer.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            function handleMouseMove(e) {
                if (!isResizing) return;

                const containerRect = container.getBoundingClientRect();
                const containerWidth = containerRect.width;
                const relativeX = e.clientX - containerRect.left;
                const percentage = (relativeX / containerWidth) * 100;

                // 限制拖曳範圍在 20% 到 80% 之間
                if (percentage >= 20 && percentage <= 80) {
                    editorPanel.style.flex = `0 0 ${percentage}%`;
                    previewPanel.style.flex = `0 0 ${100 - percentage}%`;
                }
            }

            function handleMouseUp() {
                isResizing = false;
                resizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';

                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        }

        // 初始化應用
        function init() {
            // 防抖處理 updatePreview
            const debouncedUpdatePreview = debounce(updatePreview, 300); // 300ms 延遲

            // 綁定事件
            editor.addEventListener('input', debouncedUpdatePreview);
            toggleEditor.addEventListener('click', toggleEditorVisibility);
            themeToggle.addEventListener('click', toggleTheme);
            clearBtn.addEventListener('click', clearContent);
            exportBtn.addEventListener('click', exportContent);
            importBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        editor.value = e.target.result;
                        updatePreview(); // Assuming updatePreview() is the function that refreshes the preview
                    };
                    reader.readAsText(file);
                    // Reset file input value to allow importing the same file again
                    event.target.value = null;
                }
            });

            // 初始化調整器
            initResizer();

            // 手動觸發 highlight.js (如果可用)
            if (typeof hljs !== 'undefined') {
                hljs.highlightAll();
            }

            // 初始渲染
            updatePreview();
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', init);

        // 防抖函數
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // 匯出到全域作用域以便調試
        window.DocViewer = {
            md,
            mermaid,
            toggleTheme,
            toggleEditorVisibility,
            clearContent,
            exportContent,
            updatePreview
        };

        // 模態視窗相關功能
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('diagramModal');
            const modalDiagram = document.getElementById('modalDiagram');
            const closeBtn = document.getElementById('closeModal');
            const downloadBtn = document.getElementById('downloadPng');
            const previewContainer = document.querySelector('.preview-container');
            let currentScale = 1;
            let currentDiagram = null;
            let initialDistance = 0;
            let lastX = 0;
            let lastY = 0;
            let isPanning = false;
            let currentX = 0;
            let currentY = 0;

            // 點擊預覽區域中的 mermaid 圖表時打開模態視窗
            previewContainer.addEventListener('click', function (e) {
                if (e.target.closest('.mermaid')) {
                    const diagram = e.target.closest('.mermaid');
                    currentDiagram = diagram.cloneNode(true);
                    modalDiagram.innerHTML = '';
                    modalDiagram.appendChild(currentDiagram);
                    modal.style.display = 'block';
                    currentScale = 1;
                    currentX = 0;
                    currentY = 0;
                    lastX = 0;
                    lastY = 0;
                    // 將 updateTransform 呼叫移到 requestAnimationFrame 中
                    if (!rafId) {
                        rafId = requestAnimationFrame(updateTransformInRAF);
                    }
                }
            });

            // 關閉模態視窗
            closeBtn.onclick = function () {
                modal.style.display = 'none';
            }

            // 點擊模態視窗外部時關閉
            window.onclick = function (e) {
                if (e.target == modal) {
                    modal.style.display = 'none';
                }
            }

            // 滑鼠滾輪縮放
            modalDiagram.addEventListener('wheel', function (e) {
                e.preventDefault();
                const delta = e.deltaY;
                const scaleChange = 1 - delta * 0.001;
                const newScale = currentScale * scaleChange;

                // 限制縮放範圍
                if (newScale >= 0.1 && newScale <= 10) {
                    currentScale = newScale;
                    if (!rafId) {
                        rafId = requestAnimationFrame(updateTransformInRAF);
                    }
                }
            });

            // 觸控縮放和平移
            modalDiagram.addEventListener('touchstart', function (e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    initialDistance = getTouchDistance(e.touches);
                } else if (e.touches.length === 1) {
                    isPanning = true;
                    lastX = e.touches[0].clientX;
                    lastY = e.touches[0].clientY;

                    // Get current transform for smooth start
                    if (currentDiagram) {
                        const { x, y } = getTranslateValues(currentDiagram);
                        currentX = x;
                        currentY = y;
                    }
                }
            });

            // 滑鼠拖曱功能
            modalDiagram.addEventListener('mousedown', function (e) {
                if (e.button === 0) { // 只處理左鍵點擊
                    e.preventDefault();
                    isPanning = true;
                    lastX = e.clientX;
                    lastY = e.clientY;
                    modalDiagram.classList.add('grabbing');

                    // Get current transform for smooth start
                    if (currentDiagram) {
                        const { x, y } = getTranslateValues(currentDiagram);
                        currentX = x;
                        currentY = y;
                    }
                }
            }); document.addEventListener('mousemove', function (e) {
                if (isPanning) {
                    e.preventDefault();
                    const deltaX = (e.clientX - lastX);
                    const deltaY = (e.clientY - lastY);
                    lastX = e.clientX;
                    lastY = e.clientY;

                    currentX += deltaX;
                    currentY += deltaY;

                    // 將 updateTransform 呼叫移到 requestAnimationFrame 中
                    if (!rafId) {
                        rafId = requestAnimationFrame(updateTransformInRAF);
                    }
                }
            });

            document.addEventListener('mouseup', function () {
                if (isPanning) {
                    isPanning = false;
                    modalDiagram.classList.remove('grabbing');
                    // 清除任何待處理的 requestAnimationFrame
                    if (rafId) {
                        cancelAnimationFrame(rafId);
                        rafId = null;
                    }
                }
            });

            modalDiagram.addEventListener('touchmove', function (e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = getTouchDistance(e.touches);
                    const scale = currentDistance / initialDistance;

                    const newScale = currentScale * scale;
                    if (newScale >= 0.1 && newScale <= 10) {
                        currentScale = newScale;
                        initialDistance = currentDistance;
                        // 將 updateTransform 呼叫移到 requestAnimationFrame 中
                        if (!rafId) {
                            rafId = requestAnimationFrame(updateTransformInRAF);
                        }
                    }
                } else if (e.touches.length === 1 && isPanning) {
                    e.preventDefault();
                    const deltaX = (e.touches[0].clientX - lastX);
                    const deltaY = (e.touches[0].clientY - lastY);
                    lastX = e.touches[0].clientX;
                    lastY = e.touches[0].clientY;

                    currentX += deltaX;
                    currentY += deltaY;

                    // 將 updateTransform 呼叫移到 requestAnimationFrame 中
                    if (!rafId) {
                        rafId = requestAnimationFrame(updateTransformInRAF);
                    }
                }
            });

            // 計算兩個觸控點之間的距離
            function getTouchDistance(touches) {
                const dx = touches[1].clientX - touches[0].clientX;
                const dy = touches[1].clientY - touches[0].clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            let rafId = null; // 新增用於追蹤 requestAnimationFrame 的 ID

            // 更新變形函式 (在 requestAnimationFrame 中呼叫)
            function updateTransformInRAF() {
                if (currentDiagram) {
                    currentDiagram.style.transform = `translate(${Math.round(currentX)}px, ${Math.round(currentY)}px) scale(${currentScale})`;
                }
                rafId = null; // 重置 rafId
            }

            // 更新變形函式 (原始的，現在被 updateTransformInRAF 取代，但保留以防萬一)
            function updateTransform() {
                if (currentDiagram) {
                    currentDiagram.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentScale})`;
                }
            }

            // 下載 PNG 功能            
            downloadBtn.onclick = async function () {
                if (currentDiagram) {
                    try {
                        const svgElement = currentDiagram.querySelector('svg');
                        if (!svgElement) return;

                        // 取得原始 SVG 的尺寸
                        const bbox = svgElement.getBBox();
                        const viewBox = svgElement.viewBox.baseVal;

                        // 建立高解析度尺寸 (4倍原始大小)
                        const scale = 4;
                        const width = Math.max(bbox.width, viewBox.width) * scale;
                        const height = Math.max(bbox.height, viewBox.height) * scale;

                        // 複製並調整 SVG
                        const clonedSvg = svgElement.cloneNode(true);
                        clonedSvg.setAttribute('width', width);
                        clonedSvg.setAttribute('height', height);

                        const svgData = new XMLSerializer().serializeToString(clonedSvg);
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // 建立圖片
                        const img = new Image();
                        img.onload = function () {
                            // 設定 canvas 為高解析度尺寸
                            canvas.width = width;
                            canvas.height = height;

                            // 繪製前先進行平滑處理
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';

                            // 使用白色背景（避免透明）
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);

                            // 繪製圖片
                            ctx.drawImage(img, 0, 0, width, height);

                            // 下載高品質 PNG
                            const link = document.createElement('a');
                            link.download = 'diagram-high-res.png';
                            link.href = canvas.toDataURL('image/png', 1.0); // 使用最高品質
                            link.click();
                        };

                        // 將 SVG 轉換為 base64
                        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
                    } catch (error) {
                        console.error('下載 PNG 時發生錯誤:', error);
                    }
                }
            }
        });
    </script>

    <!-- 模態視窗 -->
    <div id="diagramModal" class="modal">
        <div class="modal-content">
            <div class="modal-controls">
                <button class="modal-btn" id="downloadPng" title="下載PNG">💾</button>
                <button class="modal-btn" id="closeModal" title="關閉">❌</button>
            </div>
            <div class="modal-diagram" id="modalDiagram"></div>
        </div>
    </div>
</body>

</html>