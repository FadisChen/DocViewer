<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æª”æª¢è¦–å™¨ - DocViewer</title>

    <!-- å¼•å…¥ CodeMirror 6 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@6/dist/index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6/dist/index.css">

    <!-- å¼•å…¥ Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css"
        media="(prefers-color-scheme: dark)">

    <!-- è‡ªå®šç¾©æ¨£å¼ -->
    <style>
        :root {
            --primary-color: #007acc;
            --secondary-color: #f5f5f5;
            --background-color: #ffffff;
            --text-color: #333333;
            --border-color: #e1e4e8;
            --editor-bg: #ffffff;
            --preview-bg: #ffffff;
            --quote-color: #b00;
        }

        [data-theme="dark"] {
            --secondary-color: #2d3748;
            --background-color: #1a202c;
            --text-color: #e2e8f0;
            --border-color: #4a5568;
            --editor-bg: #2d3748;
            --preview-bg: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            height: 60px;
            background-color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            transition: background-color 0.3s ease;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--background-color);
            color: var(--text-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .container {
            height: calc(100vh - 60px);
            display: flex;
        }

        .editor-panel {
            flex: 1;
            background-color: var(--editor-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .preview-panel {
            flex: 1;
            background-color: var(--preview-bg);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            height: 40px;
            background-color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-weight: 500;
            font-size: 14px;
        }

        .editor-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .editor-textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            padding: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            background-color: var(--editor-bg);
            color: var(--text-color);
            resize: none;
            line-height: 1.5;
        }

        .preview-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .resizer {
            width: 5px;
            min-width: 5px;
            max-width: 5px;
            background-color: var(--border-color);
            cursor: col-resize;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
            flex-grow: 0;
            user-select: none;
            position: relative;
            z-index: 10;
        }

        .resizer:hover {
            background-color: var(--primary-color);
        }

        .resizer.dragging {
            background-color: var(--primary-color);
            opacity: 0.8;
        }

        /* Markdown æ¸²æŸ“æ¨£å¼ */
        .preview-content h1,
        .preview-content h2,
        .preview-content h3,
        .preview-content h4,
        .preview-content h5,
        .preview-content h6 {
            margin: 1em 0 0.5em 0;
            color: var(--text-color);
        }

        .preview-content h1 {
            font-size: 2em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }

        .preview-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }

        .preview-content p {
            margin: 1em 0;
            line-height: 1.6;
        }

        .preview-content pre {
            background-color: var(--secondary-color);
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }

        .preview-content code {
            background-color: var(--secondary-color);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .preview-content blockquote {
            border-left: 4px solid var(--quote-color);
            padding-left: 16px;
            margin: 1em 0;
        }

        .preview-content ul,
        .preview-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }

        .preview-content li {
            margin: 0.5em 0;
        }

        .preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .preview-content th,
        .preview-content td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }

        .preview-content th {
            background-color: var(--secondary-color);
            font-weight: 600;
        }

        /* Mermaid åœ–è¡¨æ¨£å¼ */
        .mermaid {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .mermaid:hover {
            transform: scale(1.02);
        }

        /* æ¨¡æ…‹è¦–çª—æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: var(--background-color);
            margin: 2% auto;
            padding: 20px;
            width: 90%;
            height: 90%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        .modal-diagram {
            cursor: grab;
        }

        .modal-diagram.grabbing {
            cursor: grabbing;
        }

        .modal-diagram .mermaid {
            cursor: grab;
        }

        .modal-diagram.grabbing .mermaid {
            cursor: grabbing;
        }

        .modal-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 1010;
        }

        .modal-btn {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            transition: all 0.2s ease;
        }

        .modal-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .modal-diagram {
            width: 100%;
            height: calc(100% - 40px);
            display: flex;
            align-items: center;
            justify-content: center;
            transform-origin: center center;
        }

        /* éŒ¯èª¤æç¤ºæ¨£å¼ */
        .error-message {
            background-color: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        .error-message strong {
            color: #a00;
            font-weight: bold;
        }

        .error-message details {
            margin-top: 10px;
        }

        .error-message summary {
            cursor: pointer;
            color: #666;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .error-message pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 5px;
            color: #333;
        }

        /* ç·¨è¼¯å™¨éš±è—ç‹€æ…‹ */
        .editor-hidden .editor-panel {
            display: none;
        }

        .editor-hidden .resizer {
            display: none;
        }

        .editor-hidden .preview-panel {
            flex: 1;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1024px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .header-controls {
                gap: 8px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 15px;
                height: 50px;
            }

            .header h1 {
                font-size: 1.1rem;
            }

            .header-controls {
                gap: 6px;
            }

            .btn {
                padding: 5px 10px;
                font-size: 12px;
            }

            .container {
                height: calc(100vh - 50px);
                flex-direction: column;
            }

            .editor-panel {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                min-height: 0;
                max-height: 60vh;
            }

            .preview-panel {
                flex: 1;
                min-height: 0;
            }

            .resizer {
                width: 100%;
                height: 5px;
                cursor: row-resize;
                min-height: 5px;
                max-height: 5px;
            }

            .panel-header {
                height: 35px;
                padding: 0 12px;
                font-size: 13px;
            }

            .editor-textarea {
                padding: 12px;
                font-size: 13px;
            }

            .preview-container {
                padding: 15px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0 10px;
                height: 45px;
            }

            .header h1 {
                font-size: 1rem;
            }

            .header-controls {
                gap: 4px;
            }

            .btn {
                padding: 4px 8px;
                font-size: 11px;
            }

            .container {
                height: calc(100vh - 45px);
            }

            .editor-panel {
                min-height: 35vh;
                max-height: 65vh;
            }

            .panel-header {
                height: 30px;
                padding: 0 10px;
                font-size: 12px;
            }

            .editor-textarea {
                padding: 10px;
                font-size: 12px;
            }

            .preview-container {
                padding: 10px;
            }

            .preview-content h1 {
                font-size: 1.5em;
            }

            .preview-content h2 {
                font-size: 1.3em;
            }

            .preview-content {
                font-size: 14px;
            }
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* è‡ªå®šç¾© Scroll Bar æ¨£å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        ::-webkit-scrollbar-corner {
            background: var(--secondary-color);
        }

        /* Firefox scroll bar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--secondary-color);
        }

        .hljs {
            color: inherit !important;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸ“ DocViewer</h1>
        <div class="header-controls">
            <button class="btn" id="toggleEditor">ğŸ“ éš±è—</button>
            <button class="btn" id="themeToggle">ğŸŒ™ æ·±è‰²</button>
            <button class="btn" id="clearBtn">ğŸ—‘ï¸ æ¸…é™¤</button>
            <button class="btn" id="importBtn">ğŸ“¥ åŒ¯å…¥</button>
            <button class="btn btn-primary" id="exportBtn">ğŸ“¤ åŒ¯å‡º</button>
        </div>
    </div>

    <input type="file" id="fileInput" hidden accept=".md,.txt">

    <div class="container">
        <div class="editor-panel">
            <div class="panel-header">
                ğŸ“ ç·¨è¼¯å€
            </div>
            <div class="editor-container">
                <textarea class="editor-textarea" id="editor" placeholder="åœ¨æ­¤è¼¸å…¥ Markdown æˆ– Mermaid èªæ³•..."></textarea>
            </div>
        </div>

        <div class="resizer" id="resizer"></div>

        <div class="preview-panel">
            <div class="panel-header">
                ğŸ‘ï¸ å³æ™‚é è¦½
            </div>
            <div class="preview-container">
                <div class="preview-content" id="preview">
                    <h1>æ­¡è¿ä½¿ç”¨ DocViewer</h1>
                    <p>è«‹åœ¨å·¦å´ç·¨è¼¯å™¨ä¸­è¼¸å…¥ Markdown æˆ– Mermaid èªæ³•ï¼Œé€™è£¡æœƒå³æ™‚é¡¯ç¤ºæ¸²æŸ“çµæœã€‚</p>

                    <h2>ç¯„ä¾‹ - Mermaid æµç¨‹åœ–</h2>
                    <div class="mermaid">
                        graph TD
                        A[é–‹å§‹] --> B{æ˜¯å¦ç‚º Markdown?}
                        B -->|æ˜¯| C[æ¸²æŸ“ Markdown]
                        B -->|å¦| D{æ˜¯å¦ç‚º Mermaid?}
                        D -->|æ˜¯| E[æ¸²æŸ“ Mermaid åœ–è¡¨]
                        D -->|å¦| F[é¡¯ç¤ºç´”æ–‡å­—]
                        C --> G[é¡¯ç¤ºçµæœ]
                        E --> G
                        F --> G
                    </div>

                    <h2>ç¯„ä¾‹ - Markdown èªæ³•</h2>
                    <pre><code># æ¨™é¡Œ 1
## æ¨™é¡Œ 2
### æ¨™é¡Œ 3

**ç²—é«”æ–‡å­—**
*æ–œé«”æ–‡å­—*
`ç¨‹å¼ç¢¼`

- æ¸…å–®é …ç›® 1
- æ¸…å–®é …ç›® 2
- æ¸…å–®é …ç›® 3

| æ¬„ä½1 | æ¬„ä½2 | æ¬„ä½3 |
|-------|-------|-------|
| å€¼1   | å€¼2   | å€¼3   |</code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥æ‰€éœ€çš„ JavaScript åº« -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

    <!-- å¼•å…¥ highlight.js -->
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/common/highlight.min.js"></script>

    <script>
        // å…¨åŸŸè®Šé‡
        let md;
        let isDarkTheme = false;

        // åˆå§‹åŒ– Markdown-it
        md = window.markdownit({
            html: true,
            linkify: true,
            typographer: false,
            highlight: function (str, lang) {
                if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                    try {
                        return '<pre><code class="hljs language-' + lang + '">' +
                            hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                            '</code></pre>';
                    } catch (__) { }
                }
                // å¦‚æœæ²’æœ‰æŒ‡å®šèªè¨€ã€hljs æœªå®šç¾©æˆ–é«˜äº®å¤±æ•—ï¼Œç›´æ¥è¿”å›åŸå§‹ç¢¼ï¼Œä¸¦ç”¨ pre å’Œ code åŒ…è£¹
                return '<pre><code class="hljs">' + md.utils.escapeHtml(str) + '</code></pre>';
            }
        });

        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });

        // é è¨­å…§å®¹
        const defaultContent = `# æ­¡è¿ä½¿ç”¨ DocViewer

é€™æ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§çš„æ–‡æª”æª¢è¦–å™¨ï¼Œæ”¯æ´ **Markdown** å’Œ **Mermaid** å³æ™‚æ¸²æŸ“ã€‚

## Mermaid æµç¨‹åœ–ç¯„ä¾‹

\`\`\`mermaid
graph TD
A[ç”¨æˆ¶è¼¸å…¥] --> B{å…§å®¹é¡å‹åˆ¤æ–·}
B -->|Markdown| C[Markdown æ¸²æŸ“]
B -->|Mermaid| D[Mermaid åœ–è¡¨æ¸²æŸ“]
C --> E[é¡¯ç¤ºçµæœ]
D --> E
E --> F[ç”¨æˆ¶æŸ¥çœ‹]
\`\`\`

## Markdown èªæ³•ç¯„ä¾‹

### æ–‡å­—æ ¼å¼
- **ç²—é«”æ–‡å­—**
- *æ–œé«”æ–‡å­—*
- ~~åˆªé™¤ç·š~~
- \`è¡Œå…§ç¨‹å¼ç¢¼\`

### æ¸…å–®
1. æœ‰åºæ¸…å–®é …ç›® 1
2. æœ‰åºæ¸…å–®é …ç›® 2
- å·¢ç‹€ç„¡åºæ¸…å–®
- å¦ä¸€å€‹é …ç›®

### è¡¨æ ¼
| åŠŸèƒ½ | æ”¯æ´ç‹€æ…‹ | èªªæ˜ |
|------|---------|------|
| Markdown æ¸²æŸ“ | âœ… | å®Œæ•´æ”¯æ´ |
| Mermaid åœ–è¡¨ | âœ… | å³æ™‚æ¸²æŸ“ |
| èªæ³•é«˜äº® | âœ… | ç¨‹å¼ç¢¼é«˜äº® |
| ä¸»é¡Œåˆ‡æ› | âœ… | æ˜æš—ä¸»é¡Œ |

### å¼•ç”¨
> é€™æ˜¯ä¸€å€‹å¼•ç”¨æ–‡å­—ï¼Œç”¨ä¾†çªå‡ºé‡è¦è³‡è¨Šã€‚

### ç¨‹å¼ç¢¼å€å¡Š
\`\`\`javascript
function hello() {
console.log("Hello, DocViewer!");
}
\`\`\`

## åºåˆ—åœ–ç¯„ä¾‹

\`\`\`mermaid
sequenceDiagram
participant U as ç”¨æˆ¶
participant E as ç·¨è¼¯å™¨
participant P as é è¦½å™¨

U->>E: è¼¸å…¥å…§å®¹
E->>P: å‚³é€å…§å®¹
P->>P: è§£ææ¸²æŸ“
P->>U: é¡¯ç¤ºçµæœ
\`\`\`
`;

        // ç²å– DOM å…ƒç´ 
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const toggleEditor = document.getElementById('toggleEditor');
        const themeToggle = document.getElementById('themeToggle');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const fileInput = document.getElementById('fileInput');

        // è¨­ç½®é è¨­å…§å®¹
        editor.value = defaultContent;

        // æ›´æ–°é è¦½
        async function updatePreview() {
            const content = editor.value;

            try {
                // å…ˆæå–æ‰€æœ‰ Mermaid ç¨‹å¼ç¢¼å€å¡Š
                const mermaidBlocks = [];
                let processedContent = content.replace(/```mermaid\n([\s\S]*?)\n```/g, (match, code) => {
                    const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                    const cleanCode = code.trim();
                    mermaidBlocks.push({ id, code: cleanCode });
                    return `<div class="mermaid-placeholder" data-id="${id}"></div>`;
                });

                // æ¸²æŸ“ Markdownï¼ˆä¸åŒ…å« Mermaid åœ–è¡¨ï¼‰
                const html = md.render(processedContent);
                preview.innerHTML = html;

                // æ¸²æŸ“ Mermaid åœ–è¡¨
                const placeholders = preview.querySelectorAll('.mermaid-placeholder');
                for (let i = 0; i < placeholders.length && i < mermaidBlocks.length; i++) {
                    const placeholder = placeholders[i];
                    const block = mermaidBlocks[i];

                    try {
                        // æ¸…ç† Mermaid ä»£ç¢¼ï¼Œç§»é™¤å¯èƒ½çš„ HTML æ¨™ç±¤å’Œå¤šé¤˜ç©ºç™½
                        const cleanCode = block.code
                            .replace(/<[^>]*>/g, '') // ç§»é™¤ HTML æ¨™ç±¤
                            .replace(/&lt;/g, '<')   // è§£ç¢¼ HTML å¯¦é«”
                            .replace(/&gt;/g, '>')
                            .replace(/&amp;/g, '&')
                            .trim();

                        const { svg } = await mermaid.render(block.id, cleanCode);
                        placeholder.outerHTML = `<div class="mermaid" id="${block.id}">${svg}</div>`;
                    } catch (error) {
                        console.error('Mermaid æ¸²æŸ“éŒ¯èª¤:', error);
                        placeholder.outerHTML = `<div class="error-message">
                    <strong>åœ–è¡¨æ¸²æŸ“éŒ¯èª¤:</strong><br/>
                    ${error.message}<br/>
                    <details>
                        <summary>æŸ¥çœ‹åŸå§‹ä»£ç¢¼</summary>
                        <pre>${block.code}</pre>
                    </details>
                </div>`;
                    }
                }
            } catch (error) {
                console.error('é è¦½æ›´æ–°éŒ¯èª¤:', error);
                preview.innerHTML = `<div class="error-message">é è¦½éŒ¯èª¤: ${error.message}</div>`;
            }
        }

        // ä¸»é¡Œåˆ‡æ›
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            const body = document.body;

            if (isDarkTheme) {
                body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = 'â˜€ï¸ æ·ºè‰²';

                // æ›´æ–° Mermaid ä¸»é¡Œ
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'dark',
                    securityLevel: 'loose'
                });
            } else {
                body.removeAttribute('data-theme');
                themeToggle.textContent = 'ğŸŒ™ æ·±è‰²';

                // é‡ç½® Mermaid ä¸»é¡Œ
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    securityLevel: 'loose'
                });
            }

            // é‡æ–°æ¸²æŸ“é è¦½
            updatePreview();
        }

        // æ¸…é™¤å…§å®¹
        function clearContent() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å…§å®¹å—ï¼Ÿ')) {
                editor.value = '';
                updatePreview();
            }
        }

        // åˆ‡æ›ç·¨è¼¯å™¨é¡¯ç¤º/éš±è—
        function toggleEditorVisibility() {
            const container = document.querySelector('.container');
            const editorPanel = document.querySelector('.editor-panel');
            const previewPanel = document.querySelector('.preview-panel');
            const isHidden = container.classList.contains('editor-hidden');

            if (isHidden) {
                // é¡¯ç¤ºç·¨è¼¯å™¨
                container.classList.remove('editor-hidden');
                toggleEditor.textContent = 'ğŸ“ éš±è—';

                // å¦‚æœä¹‹å‰æœ‰æ‹–æ›³éï¼Œæ¢å¾©ä¹‹å‰çš„æ¯”ä¾‹ï¼Œå¦å‰‡ä½¿ç”¨é è¨­ 50:50
                if (!editorPanel.style.flex || editorPanel.style.flex === '') {
                    editorPanel.style.flex = '1';
                    previewPanel.style.flex = '1';
                }
            } else {
                // éš±è—ç·¨è¼¯å™¨
                container.classList.add('editor-hidden');
                toggleEditor.textContent = 'ğŸ“ é¡¯ç¤º';

                // é‡ç½®é è¦½å€ç‚ºä½”æ»¿æ•´å€‹å¯¬åº¦ï¼Œè¦†è“‹ä»»ä½•ä¹‹å‰çš„ flex è¨­å®š
                previewPanel.style.flex = '1';
            }
        }

        // åŒ¯å‡ºåŠŸèƒ½
        function exportContent() {
            const content = editor.value;
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.md';
            a.click();
            URL.revokeObjectURL(url);
        }

        // é¢æ¿å¤§å°èª¿æ•´
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const editorPanel = document.querySelector('.editor-panel');
            const previewPanel = document.querySelector('.preview-panel');
            const container = document.querySelector('.container');
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                resizer.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            function handleMouseMove(e) {
                if (!isResizing) return;

                const containerRect = container.getBoundingClientRect();
                const containerWidth = containerRect.width;
                const relativeX = e.clientX - containerRect.left;
                const percentage = (relativeX / containerWidth) * 100;

                // é™åˆ¶æ‹–æ›³ç¯„åœåœ¨ 20% åˆ° 80% ä¹‹é–“
                if (percentage >= 20 && percentage <= 80) {
                    editorPanel.style.flex = `0 0 ${percentage}%`;
                    previewPanel.style.flex = `0 0 ${100 - percentage}%`;
                }
            }

            function handleMouseUp() {
                isResizing = false;
                resizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';

                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        function init() {
            // é˜²æŠ–è™•ç† updatePreview
            const debouncedUpdatePreview = debounce(updatePreview, 300); // 300ms å»¶é²

            // ç¶å®šäº‹ä»¶
            editor.addEventListener('input', debouncedUpdatePreview);
            toggleEditor.addEventListener('click', toggleEditorVisibility);
            themeToggle.addEventListener('click', toggleTheme);
            clearBtn.addEventListener('click', clearContent);
            exportBtn.addEventListener('click', exportContent);
            importBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        editor.value = e.target.result;
                        updatePreview(); // Assuming updatePreview() is the function that refreshes the preview
                    };
                    reader.readAsText(file);
                    // Reset file input value to allow importing the same file again
                    event.target.value = null;
                }
            });

            // åˆå§‹åŒ–èª¿æ•´å™¨
            initResizer();

            // æ‰‹å‹•è§¸ç™¼ highlight.js (å¦‚æœå¯ç”¨)
            if (typeof hljs !== 'undefined') {
                hljs.highlightAll();
            }

            // åˆå§‹æ¸²æŸ“
            updatePreview();
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // é˜²æŠ–å‡½æ•¸
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // åŒ¯å‡ºåˆ°å…¨åŸŸä½œç”¨åŸŸä»¥ä¾¿èª¿è©¦
        window.DocViewer = {
            md,
            mermaid,
            toggleTheme,
            toggleEditorVisibility,
            clearContent,
            exportContent,
            updatePreview
        };

        // æ¨¡æ…‹è¦–çª—ç›¸é—œåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('diagramModal');
            const modalDiagram = document.getElementById('modalDiagram');
            const closeBtn = document.getElementById('closeModal');
            const downloadBtn = document.getElementById('downloadPng');
            const previewContainer = document.querySelector('.preview-container');
            let currentScale = 1;
            let currentDiagram = null;
            let initialDistance = 0;
            let lastX = 0;
            let lastY = 0;
            let isPanning = false;
            let currentX = 0;
            let currentY = 0;

            // é»æ“Šé è¦½å€åŸŸä¸­çš„ mermaid åœ–è¡¨æ™‚æ‰“é–‹æ¨¡æ…‹è¦–çª—
            previewContainer.addEventListener('click', function (e) {
                if (e.target.closest('.mermaid')) {
                    const diagram = e.target.closest('.mermaid');
                    currentDiagram = diagram.cloneNode(true);
                    modalDiagram.innerHTML = '';
                    modalDiagram.appendChild(currentDiagram);
                    modal.style.display = 'block';
                    currentScale = 1;
                    currentX = 0;
                    currentY = 0;
                    lastX = 0;
                    lastY = 0;
                    // å°‡ updateTransform å‘¼å«ç§»åˆ° requestAnimationFrame ä¸­
                    if (!rafId) {
                        rafId = requestAnimationFrame(updateTransformInRAF);
                    }
                }
            });

            // é—œé–‰æ¨¡æ…‹è¦–çª—
            closeBtn.onclick = function () {
                modal.style.display = 'none';
            }

            // é»æ“Šæ¨¡æ…‹è¦–çª—å¤–éƒ¨æ™‚é—œé–‰
            window.onclick = function (e) {
                if (e.target == modal) {
                    modal.style.display = 'none';
                }
            }

            // æ»‘é¼ æ»¾è¼ªç¸®æ”¾
            modalDiagram.addEventListener('wheel', function (e) {
                e.preventDefault();
                const delta = e.deltaY;
                const scaleChange = 1 - delta * 0.001;
                const newScale = currentScale * scaleChange;

                // é™åˆ¶ç¸®æ”¾ç¯„åœ
                if (newScale >= 0.1 && newScale <= 10) {
                    currentScale = newScale;
                    if (!rafId) {
                        rafId = requestAnimationFrame(updateTransformInRAF);
                    }
                }
            });

            // è§¸æ§ç¸®æ”¾å’Œå¹³ç§»
            modalDiagram.addEventListener('touchstart', function (e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    initialDistance = getTouchDistance(e.touches);
                } else if (e.touches.length === 1) {
                    isPanning = true;
                    lastX = e.touches[0].clientX;
                    lastY = e.touches[0].clientY;

                    // Get current transform for smooth start
                    if (currentDiagram) {
                        const { x, y } = getTranslateValues(currentDiagram);
                        currentX = x;
                        currentY = y;
                    }
                }
            });

            // æ»‘é¼ æ‹–æ›±åŠŸèƒ½
            modalDiagram.addEventListener('mousedown', function (e) {
                if (e.button === 0) { // åªè™•ç†å·¦éµé»æ“Š
                    e.preventDefault();
                    isPanning = true;
                    lastX = e.clientX;
                    lastY = e.clientY;
                    modalDiagram.classList.add('grabbing');

                    // Get current transform for smooth start
                    if (currentDiagram) {
                        const { x, y } = getTranslateValues(currentDiagram);
                        currentX = x;
                        currentY = y;
                    }
                }
            }); document.addEventListener('mousemove', function (e) {
                if (isPanning) {
                    e.preventDefault();
                    const deltaX = (e.clientX - lastX);
                    const deltaY = (e.clientY - lastY);
                    lastX = e.clientX;
                    lastY = e.clientY;

                    currentX += deltaX;
                    currentY += deltaY;

                    // å°‡ updateTransform å‘¼å«ç§»åˆ° requestAnimationFrame ä¸­
                    if (!rafId) {
                        rafId = requestAnimationFrame(updateTransformInRAF);
                    }
                }
            });

            document.addEventListener('mouseup', function () {
                if (isPanning) {
                    isPanning = false;
                    modalDiagram.classList.remove('grabbing');
                    // æ¸…é™¤ä»»ä½•å¾…è™•ç†çš„ requestAnimationFrame
                    if (rafId) {
                        cancelAnimationFrame(rafId);
                        rafId = null;
                    }
                }
            });

            modalDiagram.addEventListener('touchmove', function (e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = getTouchDistance(e.touches);
                    const scale = currentDistance / initialDistance;

                    const newScale = currentScale * scale;
                    if (newScale >= 0.1 && newScale <= 10) {
                        currentScale = newScale;
                        initialDistance = currentDistance;
                        // å°‡ updateTransform å‘¼å«ç§»åˆ° requestAnimationFrame ä¸­
                        if (!rafId) {
                            rafId = requestAnimationFrame(updateTransformInRAF);
                        }
                    }
                } else if (e.touches.length === 1 && isPanning) {
                    e.preventDefault();
                    const deltaX = (e.touches[0].clientX - lastX);
                    const deltaY = (e.touches[0].clientY - lastY);
                    lastX = e.touches[0].clientX;
                    lastY = e.touches[0].clientY;

                    currentX += deltaX;
                    currentY += deltaY;

                    // å°‡ updateTransform å‘¼å«ç§»åˆ° requestAnimationFrame ä¸­
                    if (!rafId) {
                        rafId = requestAnimationFrame(updateTransformInRAF);
                    }
                }
            });

            // è¨ˆç®—å…©å€‹è§¸æ§é»ä¹‹é–“çš„è·é›¢
            function getTouchDistance(touches) {
                const dx = touches[1].clientX - touches[0].clientX;
                const dy = touches[1].clientY - touches[0].clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            let rafId = null; // æ–°å¢ç”¨æ–¼è¿½è¹¤ requestAnimationFrame çš„ ID

            // æ›´æ–°è®Šå½¢å‡½å¼ (åœ¨ requestAnimationFrame ä¸­å‘¼å«)
            function updateTransformInRAF() {
                if (currentDiagram) {
                    currentDiagram.style.transform = `translate(${Math.round(currentX)}px, ${Math.round(currentY)}px) scale(${currentScale})`;
                }
                rafId = null; // é‡ç½® rafId
            }

            // æ›´æ–°è®Šå½¢å‡½å¼ (åŸå§‹çš„ï¼Œç¾åœ¨è¢« updateTransformInRAF å–ä»£ï¼Œä½†ä¿ç•™ä»¥é˜²è¬ä¸€)
            function updateTransform() {
                if (currentDiagram) {
                    currentDiagram.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentScale})`;
                }
            }

            // ä¸‹è¼‰ PNG åŠŸèƒ½            
            downloadBtn.onclick = async function () {
                if (currentDiagram) {
                    try {
                        const svgElement = currentDiagram.querySelector('svg');
                        if (!svgElement) return;

                        // å–å¾—åŸå§‹ SVG çš„å°ºå¯¸
                        const bbox = svgElement.getBBox();
                        const viewBox = svgElement.viewBox.baseVal;

                        // å»ºç«‹é«˜è§£æåº¦å°ºå¯¸ (4å€åŸå§‹å¤§å°)
                        const scale = 4;
                        const width = Math.max(bbox.width, viewBox.width) * scale;
                        const height = Math.max(bbox.height, viewBox.height) * scale;

                        // è¤‡è£½ä¸¦èª¿æ•´ SVG
                        const clonedSvg = svgElement.cloneNode(true);
                        clonedSvg.setAttribute('width', width);
                        clonedSvg.setAttribute('height', height);

                        const svgData = new XMLSerializer().serializeToString(clonedSvg);
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // å»ºç«‹åœ–ç‰‡
                        const img = new Image();
                        img.onload = function () {
                            // è¨­å®š canvas ç‚ºé«˜è§£æåº¦å°ºå¯¸
                            canvas.width = width;
                            canvas.height = height;

                            // ç¹ªè£½å‰å…ˆé€²è¡Œå¹³æ»‘è™•ç†
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';

                            // ä½¿ç”¨ç™½è‰²èƒŒæ™¯ï¼ˆé¿å…é€æ˜ï¼‰
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);

                            // ç¹ªè£½åœ–ç‰‡
                            ctx.drawImage(img, 0, 0, width, height);

                            // ä¸‹è¼‰é«˜å“è³ª PNG
                            const link = document.createElement('a');
                            link.download = 'diagram-high-res.png';
                            link.href = canvas.toDataURL('image/png', 1.0); // ä½¿ç”¨æœ€é«˜å“è³ª
                            link.click();
                        };

                        // å°‡ SVG è½‰æ›ç‚º base64
                        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
                    } catch (error) {
                        console.error('ä¸‹è¼‰ PNG æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    }
                }
            }
        });
    </script>

    <!-- æ¨¡æ…‹è¦–çª— -->
    <div id="diagramModal" class="modal">
        <div class="modal-content">
            <div class="modal-controls">
                <button class="modal-btn" id="downloadPng" title="ä¸‹è¼‰PNG">ğŸ’¾</button>
                <button class="modal-btn" id="closeModal" title="é—œé–‰">âŒ</button>
            </div>
            <div class="modal-diagram" id="modalDiagram"></div>
        </div>
    </div>
</body>

</html>